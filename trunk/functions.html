<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF8">
 </head>
<body>
<canvas id="c" width="320" height="240" onclick="javascript:selectFunction(event);">canvas not supported</canvas>
<script>

var c = document.getElementById("c");
var ctx = c.getContext("2d");
ctx.strokeRect(0, 0, 640, 480);

var charX = 8;
var charY = 32;
var gapX = 5;
var gapY = 2;
var counter = 0;

var lineWidth = 1;
var basicWidth = 32;
var basicHeight = 32
var baselineOffset = 24;
var showRect = false;

var functions = new Array();

var selectedId = 0;

////////////////////
//                //
//   DIVIDE       //
//                //
////////////////////

function TWO_ARGS_FUNCTION() {

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;
    this.firstOffsetX = null;
    this.firstOffsetY = null;
    this.secondOffsetX = null;
    this.secondOffsetY = null;

    this.plot = function  (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "red";

        if (showRect) {ctx.strokeRect(offsetX, offsetY, this.width(), this.height());}

        this.innerPlot(offsetX, offsetY, ctx);
        this.argFirst.plot(this.firstOffsetX, this.firstOffsetY, ctx);
        this.argSecond.plot(this.secondOffsetX, this.secondOffsetY, ctx);
        functions[this.id] = this;

    }

    this.innerPlot = function (offsetX, offsetY, ctx) {



    };

    this.calculate = function (x) {
        return null;
    }


    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
        this.argFirst.remove();
        this.argSecond.remove();
        this.argFirst = null;
        this.argSecond = null;
        functions[this.id] = null;
    }

    this.width = function () {
        return null;
    }

    this.height = function () {
        return null;
    }

}



////////////////////
//                //
//   DIVIDE       //
//                //
////////////////////

DIV = new TWO_ARGS_FUNCTION();

DIV.innerPlot = function(offsetX, offsetY, ctx) {

    this.firstOffsetX = offsetX + ((Math.max(this.argSecond.width(), this.argFirst.width()) - this.argFirst.width()) / 2);
    this.firstOffsetY = offsetY;

    ctx.strokeStyle = "black";
    ctx.lineWidth = lineWidth;

    ctx.beginPath();
    ctx.moveTo(offsetX, offsetY + gapY + this.argFirst.height());
    ctx.lineTo(offsetX + Math.max(this.argSecond.width(), this.argFirst.width()), offsetY + this.argFirst.height() + gapY);
    ctx.stroke();

    this.secondOffsetX = offsetX + ((Math.max(this.argSecond.width(), this.argFirst.width()) - this.argSecond.width()) / 2);
    this.secondOffsetY = offsetY + this.argFirst.height() + gapY + gapY;

}

DIV.calculate = function (x) {
    return this.argFirst.calculate(x) / this.argSecond.calculate(x);
}

DIV.width = function () {
    return Math.max(this.argFirst.width(), this.argSecond.width());
}

DIV.height = function () {
    return this.argFirst.height() + gapY + gapY + this.argSecond.height();
}

///////////////////
//               //
//   MULTIPLY    //
//               //
///////////////////

MUL = new TWO_ARGS_FUNCTION();

MUL.innerPlot = function(offsetX, offsetY, ctx) {

/*
________________________________________________________________________
          ^
          |  offsetY       |      |      |     |
          V                |      |      |     |secondArg.width|
          _________________|      |      |     |<------------->| 
         |                 |      |      |     |_______________|_
         |                 |      |      |     |               | ^
 offsetX | firstArg.width  |      |  Ж   |     |               | | secondArg.height
<------->|<--------------->| gapX |charX | gapX|_______________|_V_
         |_________________|<----><------><--->|

*/
        var maxHeight = Math.max(this.argSecond.height(), this.argFirst.height());

        this.firstOffsetX = this.offsetX;
        this.firstOffsetY = this.offsetY + ((maxHeight - this.argFirst.height()) / 2);

        charY = Math.min(this.height(), charY);
        ctx.font = "italic " + charY + "px Georgia";
        charX = ctx.measureText("×").width
        ctx.fillText("×", offsetX + this.argFirst.width() + gapX, offsetY + (this.height() +baselineOffset)/2);

        this.secondOffsetX = this.offsetX + this.argFirst.width() + gapX + charX + gapX;
        this.secondOffsetY = this.offsetY + ((maxHeight - this.argSecond.height()) / 2)

};

MUL.calculate = function (x) {
    return this.argFirst.calculate(x) * this.argSecond.calculate(x);
}

MUL.width = function () {
    return this.argFirst.width() + gapX + charX + gapX + this.argSecond.width();
}

MUL.height = function () {
    return Math.max(this.argFirst.height(), this.argSecond.height());
}

///////////////////
//               //
//   ADD         //
//               //
///////////////////

ADD = new TWO_ARGS_FUNCTION();

ADD.innerPlot = function(offsetX, offsetY, ctx) {

/*
________________________________________________________________________
          ^
          |  offsetY       |      |      |     |
          V                |      |      |     |secondArg.width|
          _________________|      |      |     |<------------->| 
         |                 |      |      |     |_______________|_
         |                 |      |      |     |               | ^
 offsetX | firstArg.width  |      |  Ж   |     |               | | secondArg.height
<------->|<--------------->| gapX |charX | gapX|_______________|_V_
         |_________________|<----><------><--->|

*/
        var maxHeight = Math.max(this.argSecond.height(), this.argFirst.height());

        this.firstOffsetX = this.offsetX;
        this.firstOffsetY = this.offsetY + ((maxHeight - this.argFirst.height()) / 2);

        charY = Math.min(this.height(), charY);
        ctx.font = "italic " + charY + "px Georgia";
        charX = ctx.measureText("+").width
        ctx.fillText("+", offsetX + this.argFirst.width() + gapX, offsetY + (this.height()+baselineOffset)/2);

        this.secondOffsetX = this.offsetX + this.argFirst.width() + gapX + charX + gapX;
        this.secondOffsetY = this.offsetY + ((maxHeight - this.argSecond.height()) / 2)

};

ADD.calculate = function (x) {
    return this.argFirst.calculate(x) + this.argSecond.calculate(x);
}

ADD.width = function () {
    return this.argFirst.width() + gapX + charX + gapX + this.argSecond.width();
}

ADD.height = function () {
    return Math.max(this.argFirst.height(), this.argSecond.height());
}

//////////////////////////////////////////////////

function CONST(val) {
    this.value = val;
    this.id = counter++;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "blue";
        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());
        ctx.font = "italic " + this.height() + "px Georgia";
        ctx.fillText(val, offsetX + (1 / 6) * this.width(), offsetY + baselineOffset);
        functions[this.id] = this;

    }

    this.calculate = function (x) {
        return this.value;
    }

    this.replaceChild = function(_id, func) {

    }

    this.remove = function() {

    }

    this.width = function () {
        return basicWidth;
    }

    this.height = function () {
        return basicHeight;
    }


}

function VAR() {
    this.id = counter++;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "green";
        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());
        ctx.font = "italic " + this.height() + "px Georgia";
        ctx.fillText("x", offsetX + (1 / 4) * this.width(), offsetY + baselineOffset);

        functions[this.id] = this;

    }

    this.calculate = function (x) {
        return x;
    }

    this.replaceChild = function(_id, func) {

    }

    this.remove = function() {

    }

    this.width = function () {
        return basicWidth;
    }

    this.height = function () {
        return basicHeight;
    }

}

var rootFunc;
// div = Object.create(DIV);
// div.argFirst = Object.create(MUL);
// div.argFirst.argFirst = new VAR();
// div.argFirst.argSecond = new ADD();
// div.argFirst.argSecond.argFirst = new CONST(3);
// div.argFirst.argSecond.argSecond = Object.create(DIV);
// div.argFirst.argSecond.argSecond.argFirst = new CONST(4);
// div.argFirst.argSecond.argSecond.argSecond = new VAR();
// div.argSecond = new CONST(5);

rootFunc = Object.create(MUL);
rootFunc.argFirst = new VAR();
rootFunc.argSecond = new CONST(1);

plot();

function selectFunction(event) {
    // alert(event.pageX-c.offsetLeft);
    selectedId = 0;
    var i = 0;
    for (i = 0; i < functions.length; i++) {
        if (functions[i]!=null&&
                typeof(functions[i]) !== 'undefined' &&
                (event.pageX - c.offsetLeft > functions[i].offsetX) &&
                (event.pageX - c.offsetLeft) < functions[i].offsetX + functions[i].width() &&
                (event.pageY - c.offsetTop) > functions[i].offsetY &&
                (event.pageY - c.offsetLeft) < functions[i].offsetY + functions[i].height()
                ) {
            selectedId = functions[i].id;
        }
    }
    if (selectedId>0) {
        ctx.clearRect(0, 0, c.width, c.height);
        plot();
        ctx.strokeRect(
                functions[selectedId].offsetX,
                functions[selectedId].offsetY,
                functions[selectedId].width(),
                functions[selectedId].height());
    }
}

function setMultiply() {
    var child = Object.create(MUL);
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setAdd() {
    var child = Object.create(ADD);
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setDivide() {
    var child = Object.create(DIV);
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setConst() {
    var child = new CONST(2);
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setVar() {
    var child = new VAR();
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function plot() {
    rootFunc.plot(32, 32, ctx);
}


</script>
<br>

<div align="left">
    <button onClick="javascript:setMultiply();">?*?</button>
    <button onClick="javascript:setDivide();">?/?</button>
    <button onClick="javascript:setAdd();">&+&</button>
    <button onClick="javascript:setVar();">X</button>
    <button onClick="javascript:setConst();">2</button>
    <button onClick="javascript:alert(rootFunc.calculate(32));">Result</button>
</div>
</body>
</html>