<html>
<body>
<canvas id="c" width="320" height="240" onclick="javascript:selectFunction(event);">canvas not supported</canvas>
<script>

var c = document.getElementById("c");
var ctx = c.getContext("2d");
ctx.strokeRect(0, 0, 640, 480);

var charX = 8;
var gapX = 5;
var gapY = 2;
var counter = 0;

var lineWidth = 1;
var basicWidth = 32;
var basicHeight = 32;

var showRect = false;

var functions = new Array();

var selectedId = 0;

//////////////////
//                            //
//   DIVIDE           //
//                            //
//////////////////

function DIV() {

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;

        ctx.strokeStyle = "red";

        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());

        firstOffsetX = offsetX + ((Math.max(this.argSecond.width(), this.argFirst.width()) - this.argFirst.width()) / 2);
        firstOffsetY = offsetY;
        this.argFirst.plot(firstOffsetX, firstOffsetY, ctx);

        ctx.strokeStyle = "black";
        ctx.lineWidth = lineWidth;

        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY + gapY + this.argFirst.height());
        ctx.lineTo(offsetX + Math.max(this.argSecond.width(), this.argFirst.width()), offsetY + this.argFirst.height() + gapY);
        ctx.stroke();

        secondOffsetX = offsetX + ((Math.max(this.argSecond.width(), this.argFirst.width()) - this.argSecond.width()) / 2);
        secondOffsetY = offsetY + this.argFirst.height() + gapY + gapY;

        this.argSecond.plot(secondOffsetX, secondOffsetY, ctx);

        functions[this.id] = this;

    };

    this.calculate = function (x) {
        return this.argFirst.calculate(x) / this.argSecond.calculate(x);
    }


    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
//        this.argFirst.remove();
//        this.argSecond.remove();
//        this.argFirst = null;
//        this.argSecond = null;
//        functions[this.id] = null;
    }

    this.width = function () {
        return Math.max(this.argFirst.width(), this.argSecond.width());
    }

    this.height = function () {
        return this.argFirst.height() + gapY + gapY + this.argSecond.height();
    }

}

//////////////////
//                            //
//   MULTIPLY    //
//                            //
//////////////////

function MUL() {

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;

        ctx.strokeStyle = "red";

        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());

        firstOffsetX = offsetX;
        firstOffsetY = offsetY + ((Math.max(this.argSecond.height(), this.argFirst.height()) - this.argFirst.height()) / 2);
        this.argFirst.plot(firstOffsetX, firstOffsetY, ctx);

        ctx.strokeStyle = "black";

        ctx.beginPath();
        ctx.moveTo(offsetX + this.argFirst.width() + gapX, offsetY + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.lineTo(offsetX + this.argFirst.width() + gapX + charX, offsetY + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(offsetX + this.argFirst.width() + gapX, offsetY - charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.lineTo(offsetX + this.argFirst.width() + gapX + charX, offsetY + charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(offsetX + this.argFirst.width() + gapX, offsetY + charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.lineTo(offsetX + this.argFirst.width() + gapX + charX, offsetY - charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(offsetX + this.argFirst.width() + gapX + charX / 2, offsetY + charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.lineTo(offsetX + this.argFirst.width() + gapX + charX / 2, offsetY - charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.stroke();

        secondOffsetX = offsetX + this.argFirst.width() + gapX + charX + gapX;
        secondOffsetY = offsetY + ((Math.max(this.argSecond.height(), this.argFirst.height()) - this.argSecond.height()) / 2);

        this.argSecond.plot(secondOffsetX, secondOffsetY, ctx);

        functions[this.id] = this;

    };

    this.calculate = function (x) {
        return this.argFirst.calculate(x) * this.argSecond.calculate(x);
    }

    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
//        this.argFirst.remove();
//        this.argSecond.remove();
//        this.argFirst = null;
//        this.argSecond = null;
//        functions[this.id] = null;
    }

    this.width = function () {
        return this.argFirst.width() + gapX + charX + gapX + this.argSecond.width();
    }

    this.height = function () {
        return Math.max(this.argFirst.height(), this.argSecond.height());
    }

}

//////////////////
//                            //
//   ADD                 //
//                            //
//////////////////

function ADD() {

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;

        ctx.strokeStyle = "red";

        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());

        firstOffsetX = offsetX;
        firstOffsetY = offsetY + ((Math.max(this.argSecond.height(), this.argFirst.height()) - this.argFirst.height()) / 2);
        this.argFirst.plot(firstOffsetX, firstOffsetY, ctx);

        ctx.strokeStyle = "black";

        ctx.beginPath();
        ctx.moveTo(offsetX + this.argFirst.width() + gapX, offsetY + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.lineTo(offsetX + this.argFirst.width() + gapX + charX, offsetY + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(offsetX + this.argFirst.width() + gapX + charX / 2, offsetY + charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.lineTo(offsetX + this.argFirst.width() + gapX + charX / 2, offsetY - charX / 2 + Math.max(this.argSecond.height(), this.argFirst.height()) / 2);
        ctx.stroke();

        secondOffsetX = offsetX + this.argFirst.width() + gapX + charX + gapX;
        secondOffsetY = offsetY + ((Math.max(this.argSecond.height(), this.argFirst.height()) - this.argSecond.height()) / 2);

        this.argSecond.plot(secondOffsetX, secondOffsetY, ctx);

        functions[this.id] = this;

    };

    this.calculate = function (x) {
        return this.argFirst.calculate(x) + this.argSecond.calculate(x);
    }


    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
//        this.argFirst.remove();
//        this.argSecond.remove();
//        this.argFirst = null;
//        this.argSecond = null;
//        functions[this.id] = null;
    }

    this.width = function () {
        return this.argFirst.width() + gapX + charX + gapX + this.argSecond.width();
    }

    this.height = function () {
        return Math.max(this.argFirst.height(), this.argSecond.height());
    }

}

function CONST(val) {
    this.value = val;
    this.id = counter++;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "blue";
        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());
        ctx.font = "italic " + this.height() + "px Georgia";
        ctx.fillText(val, offsetX + (1 / 6) * this.width(), offsetY + this.height() * (2 / 3));
        ctx.fillText(val, offsetX + (1 / 6) * this.width(), offsetY + this.height() * (2 / 3));

        functions[this.id] = this;

    }

    this.calculate = function (x) {
        return this.value;
    }

    this.replaceChild = function(_id, func) {

    }

    this.remove = function() {

    }

    this.width = function () {
        return basicWidth;
    }

    this.height = function () {
        return basicHeight;
    }


}

function VAR() {
    this.id = counter++;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "green";
        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());
        ctx.font = "italic " + this.height() + "px Georgia";
        ctx.fillText("x", offsetX + (1 / 4) * this.width(), offsetY + this.height() * (3 / 4));

        functions[this.id] = this;

    }

    this.calculate = function (x) {
        //return x;
        return 1;
    }

    this.replaceChild = function(_id, func) {

    }

    this.remove = function() {

    }

    this.width = function () {
        return basicWidth;
    }

    this.height = function () {
        return basicHeight;
    }

}

var div;
div = new DIV();
div.argFirst = new MUL();
div.argFirst.argFirst = new VAR();
div.argFirst.argSecond = new ADD();
div.argFirst.argSecond.argFirst = new CONST(3);
div.argFirst.argSecond.argSecond = new DIV();
div.argFirst.argSecond.argSecond.argFirst = new CONST(4);
div.argFirst.argSecond.argSecond.argSecond = new VAR();
div.argSecond = new CONST(5);

offsetX = 0;//(c.width-div.width())/2
offsetY = 0;//(c.height-div.height())/2

div.plot(offsetX, offsetY, ctx);

function selectFunction(event) {
    // alert(event.pageX-c.offsetLeft);
    var i = 0;
    for (i = 0; i < functions.length; i++) {
        if (typeof(functions[i]) !== 'undefined' &&
                (event.pageX - c.offsetLeft > functions[i].offsetX) &&
                (event.pageX - c.offsetLeft) < functions[i].offsetX + functions[i].width() &&
                (event.pageY - c.offsetTop) > functions[i].offsetY &&
                (event.pageY - c.offsetLeft) < functions[i].offsetY + functions[i].height()
                ) {
            selectedId = functions[i].id;
        }
    }
    ctx.clearRect(0, 0, c.width, c.height);
    div.plot(0, 0, ctx);
    ctx.strokeRect(
            functions[selectedId].offsetX,
            functions[selectedId].offsetY,
            functions[selectedId].width(),
            functions[selectedId].height());
}

function setMultiply() {
    var child = new MUL();
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    div.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    div.plot(0, 0, ctx);
}

function setAdd() {
    var child = new ADD();
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    div.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    div.plot(0, 0, ctx);
}

function setDivide() {
    var child = new DIV();
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    div.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    div.plot(0, 0, ctx);
}

function setConst() {
    var child = new CONST(2);
    div.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    div.plot(0, 0, ctx);
}

function setVar() {
    var child = new VAR();
    div.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    div.plot(0, 0, ctx);
}


</script>
<br>

<div align="left">
    <button onClick="javascript:setMultiply();">?*?</button>
    <button onClick="javascript:setDivide();">?/?</button>
    <button onClick="javascript:setAdd();">&+&</button>
    <button onClick="javascript:setVar();">X</button>
    <button onClick="javascript:setConst();">2</button>
    <button onClick="javascript:alert(div.calculate());">Result</button>
</div>
</body>
</html>