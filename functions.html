<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF8">
 </head>
<body>
<canvas id="c" width="620" height="480" onclick="javascript:selectFunction(event);">canvas not supported</canvas>
<canvas id="a" width="620" height="480">canvas not supported</canvas>
<script>

var c = document.getElementById("c");
var ctx = c.getContext("2d");
ctx.strokeRect(0, 0, c.width, c.height);

var charX = 8;
var charY = 32;
var gapX = 4;
var gapY = 4;
var counter = 0;

var lineWidth = 1;
//var basicWidth = 32;
var basicHeight = 64;
var baselineOffset = basicHeight * (3/4);
var showRect = false;

ctx.font = "italic " + basicHeight + "px Georgia";

var functions = new Array();

var selectedId = 0;

////////////////////
//                //
//   DIVIDE       //
//                //
////////////////////

function TWO_ARGS_FUNCTION() {

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;
    this.firstOffsetX = null;
    this.firstOffsetY = null;
    this.secondOffsetX = null;
    this.secondOffsetY = null;

    this.plot = function  (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "red";

        if (showRect) {ctx.strokeRect(offsetX, offsetY, this.width(), this.height());}

        this.innerPlot(offsetX, offsetY, ctx);
        this.argFirst.plot(this.firstOffsetX, this.firstOffsetY, ctx);
        this.argSecond.plot(this.secondOffsetX, this.secondOffsetY, ctx);
        functions[this.id] = this;

    }

    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
        this.argFirst.remove();
        this.argSecond.remove();
        this.argFirst = null;
        this.argSecond = null;
        functions[this.id] = null;
    }

    this.innerPlot = function (offsetX, offsetY, ctx) {



    };

    this.calculate = function (x) {
        return null;
    }

    this.width = function () {
        return null;
    }

    this.height = function () {
        return null;
    }

}


function ROOT_FUNCTION () {    

    this.id = counter++;
    this.arg = null;
    this.argOffsetX = null;
    this.argOffsetY = null;
    
    this.plot = function  (offsetX, offsetY, ctx) {

        this.offsetX = 0;
        this.offsetY = 0;
        ctx.strokeStyle = "red";

        if (showRect) {ctx.strokeRect(offsetX, offsetY, this.width(), this.height());}

        this.innerPlot(offsetX, offsetY, ctx);
        this.arg.plot(this.argOffsetX, this.argOffsetY, ctx);
        functions[this.id] = this;

    }

    this.replaceChild = function(_id, func) {
        if (this.arg.id==_id) {
            this.arg.remove();
            this.arg = func;
        } else {
            this.arg.replaceChild(_id, func);
        }
    }

    this.remove = function() {
        this.arg.remove();
        functions[this.arg.id]=null;
        functions[this.id] = null;
    }

    this.innerPlot = function(offsetX, offsetY, ctx) {

        var marginX = (this.width()- ctx.measureText("y(x)=").width -this.arg.width()-gapX)/2;

        this.argOffsetX = marginX + ctx.measureText("y(x)=").width + gapX;
        this.argOffsetY = (this.height()-this.arg.height())/2;

        ctx.fillText("y(x)=", marginX, baselineOffset+(this.height()-basicHeight)/2);

    }

    this.calculate = function (x) {
        return this.arg.calculate(x);
    }

    this.width = function () {
        return c.width;
    }

    this.height = function () {
        return c.height;
    }

}


////////////////////
//                //
//   DIVIDE       //
//                //
////////////////////

function DIV () {    

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;
    this.firstOffsetX = null;
    this.firstOffsetY = null;
    this.secondOffsetX = null;
    this.secondOffsetY = null;

    this.plot = function  (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "red";

        if (showRect) {ctx.strokeRect(offsetX, offsetY, this.width(), this.height());}

        this.innerPlot(offsetX, offsetY, ctx);
        this.argFirst.plot(this.firstOffsetX, this.firstOffsetY, ctx);
        this.argSecond.plot(this.secondOffsetX, this.secondOffsetY, ctx);
        functions[this.id] = this;

    }

    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
        this.argFirst.remove();
        this.argSecond.remove();
        functions[this.argFirst.id]=null;
        functions[this.argSecond.id]=null;
        this.argFirst = null;
        this.argSecond = null;
        functions[this.id] = null;
    }

    this.innerPlot = function(offsetX, offsetY, ctx) {

        this.firstOffsetX = offsetX + ((Math.max(this.argSecond.width(), this.argFirst.width()) - this.argFirst.width()) / 2);
        this.firstOffsetY = offsetY;

        ctx.strokeStyle = "black";
        ctx.lineWidth = lineWidth;

        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY + gapY + this.argFirst.height());
        ctx.lineTo(offsetX + Math.max(this.argSecond.width(), this.argFirst.width()), offsetY + this.argFirst.height() + gapY);
        ctx.stroke();

        this.secondOffsetX = offsetX + ((Math.max(this.argSecond.width(), this.argFirst.width()) - this.argSecond.width()) / 2);
        this.secondOffsetY = offsetY + this.argFirst.height() + gapY + gapY;

    }

    this.calculate = function (x) {
        return this.argFirst.calculate(x) / this.argSecond.calculate(x);
    }

    this.width = function () {
        return Math.max(this.argFirst.width(), this.argSecond.width());
    }

    this.height = function () {
        return this.argFirst.height() + gapY + gapY + this.argSecond.height();
    }

}

///////////////////
//               //
//   MULTIPLY    //
//               //
///////////////////

function MUL() {

    this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;
    this.firstOffsetX = null;
    this.firstOffsetY = null;
    this.secondOffsetX = null;
    this.secondOffsetY = null;

    this.plot = function  (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "red";

        if (showRect) {ctx.strokeRect(offsetX, offsetY, this.width(), this.height());}

        this.innerPlot(offsetX, offsetY, ctx);
        this.argFirst.plot(this.firstOffsetX, this.firstOffsetY, ctx);
        this.argSecond.plot(this.secondOffsetX, this.secondOffsetY, ctx);
        functions[this.id] = this;

    }

    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
        this.argFirst.remove();
        this.argSecond.remove();
        functions[this.argFirst.id]=null;
        functions[this.argSecond.id]=null;
        this.argFirst = null;
        this.argSecond = null;
        functions[this.id] = null;
    }


    this.innerPlot = function(offsetX, offsetY, ctx) {

/*
________________________________________________________________________
          ^
          |  offsetY       |      |      |     |
          V                |      |      |     |secondArg.width|
          _________________|      |      |     |<------------->| 
         |                 |      |      |     |_______________|_
         |                 |      |      |     |               | ^
 offsetX | firstArg.width  |      |  Ж   |     |               | | secondArg.height
<------->|<--------------->| gapX |charX | gapX|_______________|_V_
         |_________________|<----><------><--->|

*/
        var maxHeight = Math.max(this.argSecond.height(), this.argFirst.height());

        this.firstOffsetX = this.offsetX;
        this.firstOffsetY = this.offsetY + ((maxHeight - this.argFirst.height()) / 2);

        charY = Math.min(this.height(), charY);
        charX = ctx.measureText("×").width
        ctx.fillText("×", offsetX + this.argFirst.width() + gapX, offsetY + baselineOffset + (this.height() - basicHeight)/2);

        this.secondOffsetX = this.offsetX + this.argFirst.width() + gapX + charX + gapX;
        this.secondOffsetY = this.offsetY + ((maxHeight - this.argSecond.height()) / 2)

};

this.calculate = function (x) {
    return this.argFirst.calculate(x) * this.argSecond.calculate(x);
}

this.width = function () {
    return this.argFirst.width() + gapX + charX + gapX + this.argSecond.width();
}

this.height = function () {
    return Math.max(this.argFirst.height(), this.argSecond.height());
}

}

///////////////////
//               //
//   ADD         //
//               //
///////////////////

function ADD() {

  this.id = counter++;
    this.argFirst = null;
    this.argSecond = null;
    this.offsetX = null;
    this.offsetY = null;
    this.firstOffsetX = null;
    this.firstOffsetY = null;
    this.secondOffsetX = null;
    this.secondOffsetY = null;

    this.plot = function  (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "red";

        if (showRect) {ctx.strokeRect(offsetX, offsetY, this.width(), this.height());}

        this.innerPlot(offsetX, offsetY, ctx);
        this.argFirst.plot(this.firstOffsetX, this.firstOffsetY, ctx);
        this.argSecond.plot(this.secondOffsetX, this.secondOffsetY, ctx);
        functions[this.id] = this;

    }

    this.replaceChild = function(_id, func) {
        if (this.argFirst.id==_id) {
            this.argFirst.remove();
            this.argFirst=func;
        } else if (this.argSecond.id==_id) {
            this.argSecond.remove();
            this.argSecond=func;
        } else {
            this.argFirst.replaceChild(_id, func);
            this.argSecond.replaceChild(_id, func);
        }
    }

    this.remove = function() {
        this.argFirst.remove();
        this.argSecond.remove();
        functions[this.argFirst.id]=null;
        functions[this.argSecond.id]=null;
        this.argFirst = null;
        this.argSecond = null;
        functions[this.id] = null;
    }


    this.innerPlot = function(offsetX, offsetY, ctx) {

        var maxHeight = Math.max(this.argSecond.height(), this.argFirst.height());

        this.firstOffsetX = this.offsetX;
        this.firstOffsetY = this.offsetY + ((maxHeight - this.argFirst.height()) / 2);

        charX = ctx.measureText("+").width
        ctx.fillText("+", offsetX + this.argFirst.width() + gapX, offsetY + baselineOffset + (this.height() - basicHeight)/2);

        this.secondOffsetX = this.offsetX + this.argFirst.width() + gapX + charX + gapX;
        this.secondOffsetY = this.offsetY + ((maxHeight - this.argSecond.height()) / 2)

    }

    this.calculate = function (x) {
        return this.argFirst.calculate(x) + this.argSecond.calculate(x);
    }

    this.width = function () {
        return this.argFirst.width() + gapX + charX + gapX + this.argSecond.width();
    }

    this.height = function () {
        return Math.max(this.argFirst.height(), this.argSecond.height());
    }

}

//////////////////////////////////////////////////

function CONST(val) {
    
    this.value = val;
    this.id = counter++;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "blue";
        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());
        ctx.font = "italic " + this.height() + "px Georgia";
        ctx.fillText(val, offsetX, offsetY + baselineOffset);
        functions[this.id] = this;

    }

    this.calculate = function (x) {
        return this.value;
    }

    this.replaceChild = function(_id, func) {

    }

    this.remove = function() {
        functions[this.id] = null;
    }

    this.width = function () {
        return ctx.measureText(val).width;
    }

    this.height = function () {
        return basicHeight;
    }


}

function VAR() {
    this.id = counter++;
    this.offsetX = null;
    this.offsetY = null;

    this.plot = function (offsetX, offsetY, ctx) {

        this.offsetX = offsetX;
        this.offsetY = offsetY;
        ctx.strokeStyle = "green";
        if (showRect)
            ctx.strokeRect(offsetX, offsetY, this.width(), this.height());
        ctx.font = "italic " + this.height() + "px Georgia";
        ctx.fillText("x", offsetX, offsetY + baselineOffset);

        functions[this.id] = this;

    }

    this.calculate = function (x) {
        return x;
    }

    this.replaceChild = function(_id, func) {

    }

    this.remove = function() {
        functions[this.id] = null;
    }

    this.width = function () {
        return ctx.measureText("x").width;
    }

    this.height = function () {
        return basicHeight;
    }

}

var rootFunc;

// div = Object.create(DIV);
// div.argFirst = Object.create(MUL);
// div.argFirst.argFirst = new VAR();
// div.argFirst.argSecond = new ADD();
// div.argFirst.argSecond.argFirst = new CONST(3);
// div.argFirst.argSecond.argSecond = Object.create(DIV);
// div.argFirst.argSecond.argSecond.argFirst = new CONST(4);
// div.argFirst.argSecond.argSecond.argSecond = new VAR();
// div.argSecond = new CONST(5);

rootFunc =  new ROOT_FUNCTION();
rootFunc.arg = new MUL();
rootFunc.arg.argFirst = new VAR();
rootFunc.arg.argSecond = new CONST(1);

plot();

function selectFunction(event) {
    // alert(event.pageX-c.offsetLeft);
    selectedId = 0;
    var i = 0;
    for (i = 0; i < functions.length; i++) {
        if (functions[i]!=null&&
                typeof(functions[i]) !== 'undefined' &&
                (event.pageX - c.offsetLeft > functions[i].offsetX) &&
                (event.pageX - c.offsetLeft) < functions[i].offsetX + functions[i].width() &&
                (event.pageY - c.offsetTop) > functions[i].offsetY &&
                (event.pageY - c.offsetLeft) < functions[i].offsetY + functions[i].height()
                ) {
            selectedId = functions[i].id;
        }
    }
    if (selectedId>0) {
        ctx.clearRect(0, 0, c.width, c.height);
        plot();
        ctx.strokeRect(
                functions[selectedId].offsetX,
                functions[selectedId].offsetY,
                functions[selectedId].width(),
                functions[selectedId].height());
    }
}

function setMultiply() {
    var child = new MUL();
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setAdd() {
    var child = new ADD();
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setDivide() {
    var child = new DIV();
    child.argFirst = new CONST("?");
    child.argSecond = new CONST("?");
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setConst(i) {
    var child = new CONST(i);
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function setVar() {
    var child = new VAR();
    rootFunc.replaceChild(selectedId, child);
    ctx.clearRect(0, 0, c.width, c.height);
    plot();
}

function plot() {
    ctx.strokeRect(0, 0, c.width, c.height);
    rootFunc.plot(32, 32, ctx);
}

function check() {
    var str = "";
    for (i in functions) {
        if (functions[i]!=null) {
            str += functions[i].id + "   ";
        }
    }
    alert(str);
}

</script>

<script>

///////////////////////////
///////////////////////////
//                       // 
//   GRAPH SECTION       //
//                       //
///////////////////////////
///////////////////////////

    var canvas = document.getElementById("a");
    var context = canvas.getContext("2d");

    var startX = -2;
    var startY = -1;
    var endX = 2;
    var     endY = 1;

    var     stepX = (endX-startX)/1000;

    function translateX(x) {
        var A = canvas.width/(endX-startX);
        var B = -A * startX;
        return (A*x + B);       
    }

    function translateY(y) {
        var A = canvas.height/(startY-endY);
        var B = -A * endY;
        return (A*y + B);       
    }



    function map(point) {

        var mappedPoint = new Array();

        var A1 = canvas.width/(endX-startX);
        var B1 = -A1 * startX;

        var A2 = canvas.height/(startY-endY);
        var B2 = -A2 * endY;

        mappedPoint[0] = A1*point[0] + B1;
        mappedPoint[1] = A2*point[1] + B2;

        return mappedPoint;

    }


    function translateY(y) {
        var A = canvas.height/(startY-endY);
        var B = -A * endY;
        return (A*y + B);       
    }



    function axisX(startX, startY, endX, endY) {

        context.strokeStyle = '#000000';

        context.beginPath();
            context.moveTo(canvas.width/2, 0);
            context.lineTo(canvas.width/2, canvas.height);
            context.stroke();   

        context.beginPath();
            context.moveTo(0, canvas.height/2);
            context.lineTo(canvas.width, canvas.height/2);
            context.stroke();   

    }

    

    function func(x) {
        return rootFunc.calculate(x);
    }


    function graph() {


        context.strokeStyle = '#ff0000';

        var x;
    
        for (x=startX; x<endX; x+=stepX) {
            context.beginPath();
                context.moveTo(translateX(x), translateY(func(x)));
                context.lineTo(translateX(x+stepX), translateY(func(x+stepX)));
                context.stroke();   
            context.closePath();
        }
    }

    function clearGraph() {
        //context.clearRect(canvas.offsetLeft, canvas.offsetTop, canvas.width, canvas.height);
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

</script>


<br>

<div align="left">
    <button onClick="javascript:setMultiply();"><h2>?×?</h2></button>
    <button onClick="javascript:setDivide();"><h2>?/?</h2></button>
    <button onClick="javascript:setAdd();"><h2>?+?</h2></button>
    <button onClick="javascript:setVar();"><h2>X</h2></button>
    <button onClick="javascript:setConst(-1);"><h2>-1</h2></button>
    <button onClick="javascript:setConst(1);"><h2>1</h2></button>
    <button onClick="javascript:setConst(2);"><h2>2</h2></button>
    <button onClick="javascript:alert(rootFunc.calculate(32));"><h2>Result</h2></button>
    <button onClick="javascript:check();"><h2>Check</h2></button>
    <button onClick="javascript:graph();"><h2>Graph</h2></button>
    <button onClick="javascript:clearGraph();"><h2>Clear</h2></button>
</div>
<span id="check"></span>
</body>
</html>